<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kcmetercec.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="kernel version arch    v5.4.0 arm32">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux下进程和线程的调度">
<meta property="og:url" content="http://kcmetercec.top/2024/09/02/linux_process_schedule/index.html">
<meta property="og:site_name" content="explorer">
<meta property="og:description" content="kernel version arch    v5.4.0 arm32">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/KcMeterCEC/explore/blob/master/%5BLinux%5D/%5BPS%5D/%5BWhat%5Dps--schedule/cpu_io.jpg?raw=true">
<meta property="article:published_time" content="2024-09-01T16:00:00.000Z">
<meta property="article:modified_time" content="2024-09-01T16:00:00.000Z">
<meta property="article:author" content="kcmetercec">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/KcMeterCEC/explore/blob/master/%5BLinux%5D/%5BPS%5D/%5BWhat%5Dps--schedule/cpu_io.jpg?raw=true">

<link rel="canonical" href="http://kcmetercec.top/2024/09/02/linux_process_schedule/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux下进程和线程的调度 | explorer</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112423075-1# <app_id>"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-112423075-1# <app_id>');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="explorer" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">explorer</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">万丈高楼平地起，勿在浮沙筑高台</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://kcmetercec.top/2024/09/02/linux_process_schedule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/16881795?s=400&u=f62971f44f59d17d823044e709d4668debec7c02&v=4">
      <meta itemprop="name" content="kcmetercec">
      <meta itemprop="description" content="Qt, C++, linux, CS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="explorer">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux下进程和线程的调度
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-09-02 00:00:00" itemprop="dateCreated datePublished" datetime="2024-09-02T00:00:00+08:00">2024-09-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/process/" itemprop="url" rel="index"><span itemprop="name">process</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/process/overview/" itemprop="url" rel="index"><span itemprop="name">overview</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <table>
<thead>
<tr>
<th>kernel version</th>
<th>arch</th>
</tr>
</thead>
<tbody><tr>
<td>v5.4.0</td>
<td>arm32</td>
</tr>
</tbody></table>
<span id="more"></span>

<h1 id="调度的目标"><a href="#调度的目标" class="headerlink" title="调度的目标"></a>调度的目标</h1><h2 id="吞吐和响应"><a href="#吞吐和响应" class="headerlink" title="吞吐和响应"></a>吞吐和响应</h2><p>操作系统的主要目标是要在保持高的吞吐量的同时还要有高的响应速度。</p>
<ul>
<li>吞吐量：整个系统在单位时间内做的有用功越多，吞吐量就越大<ul>
<li>进程的切换，代码的局部搬移都属于无用功</li>
</ul>
</li>
<li>响应速度：当发生切换请求时，要以尽量快的完成切换，哪怕牺牲其他的任务为代价<ul>
<li>这其中就包含了进程环境切换，以及代码局部性处理的搬移（cache miss 而导致的需要读内存）</li>
</ul>
</li>
</ul>
<p>毫无疑问，这两个指标是互相矛盾的，只有选择一个侧重点。</p>
<p>在内核配置的 <code>Kernel Features -&gt; Preemption Model</code> 中可以选择调度策略：</p>
<ul>
<li>No Forced Preemption(Server): 不能被抢占</li>
<li>Voluntary Kernel Preemption(Desktop): kernel自愿让出</li>
<li>Preemptible Kernle(Low-Latency Desktop):kernel可以被抢占(嵌入式系统一般都选择此项)</li>
</ul>
<h2 id="CPU与I-O平衡"><a href="#CPU与I-O平衡" class="headerlink" title="CPU与I/O平衡"></a>CPU与I/O平衡</h2><p>进程分为两种类型：</p>
<ul>
<li>I/O消耗型：更多的是I/O操作，对CPU的占用率低<ul>
<li>在I/O操作时，一般进程会阻塞的等待，CPU会被让出去</li>
</ul>
</li>
<li>CPU消耗型：更多的操作是在CPU的运算上</li>
</ul>
<p>当以红蓝图来显示CPU的消耗如下图：</p>
<p><img src="https://github.com/KcMeterCEC/explore/blob/master/%5BLinux%5D/%5BPS%5D/%5BWhat%5Dps--schedule/cpu_io.jpg?raw=true"><br>由此可以看出，在调度时，我们应该 <strong>优先调度I/O消耗型</strong> ，以让其尽快响应。</p>
<ul>
<li>I/O型的进程消耗时间绝大部分是在I/O设备上，所以其对CPU的性能要求并不高<ul>
<li>ARM通过big.LITTLE架构来组成4小核和4大核，让小核来做I/O任务，大核做运算任务<ul>
<li>虽然小核处理能力弱，但其功耗低。而且从宏观上看其性能依然是8核的性能</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h1><h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>Linux的优先级从0~139，数值越低优先级越高。</p>
<ul>
<li>在内核中，设置的值便与优先级一一对应</li>
<li>在用户空间中，设置的RT值通过公式 <code>99 - priority</code> 来计算真实的优先级(所以在用户空间中，设置的RT值越小优先级反而越低)，而设置的 NICE 值则又是<code>100+20+priority</code>而得到的（这种情况也是 NICE 值越低，优先级越高）。</li>
</ul>
<h2 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h2><p>其中0<del>99使用RT策略，100</del>139使用NICE策略。</p>
<ul>
<li>关于内核、用户空间、top命令中的优先级显示，参看<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/44Gamu17Vkl77OGV2KkRmQ">此文章</a></li>
</ul>
<table>
<thead>
<tr>
<th>用户</th>
<th>内核</th>
<th>Top</th>
</tr>
</thead>
<tbody><tr>
<td>RT 50</td>
<td>49(99-RT)</td>
<td>-51(-1-RT)</td>
</tr>
<tr>
<td>RT99</td>
<td>0</td>
<td>rt</td>
</tr>
<tr>
<td>NICE 5</td>
<td>125</td>
<td>25(20+NICE)</td>
</tr>
</tbody></table>
<p>通过上表也可以看出：</p>
<ol>
<li><p>使用 Top 看到的优先级，数值越小优先级越高</p>
</li>
<li><p>使用 Top 看到的优先级如果小于0 或 rt 则是 RT 策略，否则就是 NICE 策略</p>
</li>
</ol>
<h3 id="RT策略"><a href="#RT策略" class="headerlink" title="RT策略"></a>RT策略</h3><p>RT策略分为 SCHED_FIFO 和 SCHED_RR:</p>
<ul>
<li>SCHED_FIFO:霸占CPU，除非自己主动让出<ul>
<li>在不同优先级的情况下，高优先级的对象先运行， <strong>并且要等待此对象主动释放CPU，其他对象才能依次运行</strong><ul>
<li>在同优先级下，也是要等待主动释放，所以才称为FIFO(first in first out)策略</li>
</ul>
</li>
</ul>
</li>
<li>SCHED_RR:高优先级的对象先运行，同等优先级轮转<ul>
<li>在不同优先级的情况下，高优先级的对象先运行， <strong>并且要等待此对象主动释放CPU，其他对象才能依次运行</strong><ul>
<li>在同优先级下，对象轮转运行，所以才称为RR(round-robin)策略</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>可以看出，SCHED_FIFO和SCHED_RR在不同优先级的情况下策略是一样的，区别是在同等优先级的情况下。</p>
<h3 id="NICE策略"><a href="#NICE策略" class="headerlink" title="NICE策略"></a>NICE策略</h3><ul>
<li>不同优先级下，高优先级 <strong>可以抢占低优先级运行</strong> ，但 <strong>高优先级不会霸占CPU，而是会被调度器主动剥夺CPU使用权用于低优先级运行</strong><ul>
<li>虽然是轮转运行，但高优先级可以获得的时间片比低优先级要多</li>
</ul>
</li>
<li>nice值在 -20 ~ +19 对应优先级的 100 ~ 139<ul>
<li>nice值越高其优先级越低，运行的时间片越少</li>
<li>默认新建进程的Nice值为0</li>
</ul>
</li>
</ul>
<h2 id="策略补丁"><a href="#策略补丁" class="headerlink" title="策略补丁"></a>策略补丁</h2><h3 id="RT门限"><a href="#RT门限" class="headerlink" title="RT门限"></a>RT门限</h3><p>根据RT策略来讲如果 RT 里面的线程没有主动让出CPU，那 NICE 策略的进程就无法运行。<br>为此，linux 在 2.6 以后设置了 RT 门限，以设置 RT 策略的进程只能在一个周期里运行确定的时间。</p>
<p>在 <code>/proc/sys/kernel/</code> 下的 <code>sched_rt_period_us,sched_rt_runtime_us</code> 来设置 period和runtime。</p>
<ul>
<li>也就是是在period的时间里，RT进程只能最多运行runtime时间。</li>
<li>可以通过命令 <code>chrt -f -a -p &lt;prio&gt; &lt;pid&gt;</code> 来改变进程的优先级</li>
</ul>
<h3 id="CFS-完全公平调度-NICE策略优化"><a href="#CFS-完全公平调度-NICE策略优化" class="headerlink" title="CFS :完全公平调度(NICE策略优化)"></a>CFS :完全公平调度(NICE策略优化)</h3><ul>
<li><p>NICE策略下的进程都具有一个权重</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ,* Nice levels are multiplicative, with a gentle 10% change for every</span></span><br><span class="line"><span class="comment"> ,* nice level changed. I.e. when a CPU-bound task goes from nice 0 to</span></span><br><span class="line"><span class="comment"> ,* nice 1, it will get ~10% less CPU time than another CPU-bound task</span></span><br><span class="line"><span class="comment"> ,* that remained on nice 0.</span></span><br><span class="line"><span class="comment"> ,*</span></span><br><span class="line"><span class="comment"> ,* The &quot;10% effect&quot; is relative and cumulative: from _any_ nice level,</span></span><br><span class="line"><span class="comment"> ,* if you go up 1 level, it&#x27;s -10% CPU usage, if you go down 1 level</span></span><br><span class="line"><span class="comment"> ,* it&#x27;s +10% CPU usage. (to achieve that we use a multiplier of 1.25.</span></span><br><span class="line"><span class="comment"> ,* If a task goes up by ~10% and another task goes down by ~10% then</span></span><br><span class="line"><span class="comment"> ,* the relative distance between them is ~25%.)</span></span><br><span class="line"><span class="comment"> ,*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> prio_to_weight[<span class="number">40</span>] = &#123;</span><br><span class="line"> <span class="comment">/* -20 */</span>     <span class="number">88761</span>,     <span class="number">71755</span>,     <span class="number">56483</span>,     <span class="number">46273</span>,     <span class="number">36291</span>,</span><br><span class="line"> <span class="comment">/* -15 */</span>     <span class="number">29154</span>,     <span class="number">23254</span>,     <span class="number">18705</span>,     <span class="number">14949</span>,     <span class="number">11916</span>,</span><br><span class="line"> <span class="comment">/* -10 */</span>      <span class="number">9548</span>,      <span class="number">7620</span>,      <span class="number">6100</span>,      <span class="number">4904</span>,      <span class="number">3906</span>,</span><br><span class="line"> <span class="comment">/*  -5 */</span>      <span class="number">3121</span>,      <span class="number">2501</span>,      <span class="number">1991</span>,      <span class="number">1586</span>,      <span class="number">1277</span>,</span><br><span class="line"> <span class="comment">/*   0 */</span>      <span class="number">1024</span>,       <span class="number">820</span>,       <span class="number">655</span>,       <span class="number">526</span>,       <span class="number">423</span>,</span><br><span class="line"> <span class="comment">/*   5 */</span>       <span class="number">335</span>,       <span class="number">272</span>,       <span class="number">215</span>,       <span class="number">172</span>,       <span class="number">137</span>,</span><br><span class="line"> <span class="comment">/*  10 */</span>       <span class="number">110</span>,        <span class="number">87</span>,        <span class="number">70</span>,        <span class="number">56</span>,        <span class="number">45</span>,</span><br><span class="line"> <span class="comment">/*  15 */</span>        <span class="number">36</span>,        <span class="number">29</span>,        <span class="number">23</span>,        <span class="number">18</span>,        <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>虚拟运行时间通过公式计算： <code>vtime = ptime * 1024 / weight</code> (NICE值越大，权重越小，虚拟运行时间越高)</p>
<ul>
<li>ptime : 实际运行时间</li>
<li>weight : 权重</li>
<li>1024: 对应NICE为0的权重</li>
</ul>
</li>
<li><p>将此虚拟运行时间挂在一颗红黑树上</p>
</li>
<li><p>linux首先运行红黑树上值最小的节点，当节点运行其ptime会继续增加</p>
<ul>
<li>所有随着时间推移，该节点将不会是最小的节点</li>
</ul>
</li>
</ul>
<p>基于以上这个逻辑， <strong>I/O型的ptime就比较小，所有它就会被优先调度</strong> ，这就满足了优先运行I/O型进程的初衷。</p>
<ul>
<li>可以通过 <code>renice -n &lt;nice_value&gt; -g &lt;pid&gt;</code> 来修改进程的nice值</li>
<li>可以通过 <code>nice &lt;nice_value&gt; &lt;process&gt;</code> 来启动一个进程并设置nice</li>
</ul>
<h2 id="设置API"><a href="#设置API" class="headerlink" title="设置API"></a>设置API</h2><table>
<thead>
<tr>
<th>System Call</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>nice()</td>
<td>设置进程的nice值</td>
</tr>
<tr>
<td>sched_setscheduler()</td>
<td>设置调度策略</td>
</tr>
<tr>
<td>sched_getscheduler()</td>
<td>获取调度策略</td>
</tr>
<tr>
<td>sched_setparam()</td>
<td>设置RT策略优先级</td>
</tr>
<tr>
<td>sched_getparam()</td>
<td>获取RT策略优先级</td>
</tr>
<tr>
<td>sched_get_priority_max()</td>
<td>得到RT策略最高优先级</td>
</tr>
<tr>
<td>sched_get_priority_min()</td>
<td>得到RT策略最低优先级</td>
</tr>
<tr>
<td>sched_rr_get_interval()</td>
<td>得到RR策略时间片参数</td>
</tr>
<tr>
<td>sched_setaffinity()</td>
<td>设置进程关系</td>
</tr>
<tr>
<td>sched_getaffinity()</td>
<td>获取进程关系</td>
</tr>
<tr>
<td>sched_yield()</td>
<td>主动让出CPU</td>
</tr>
</tbody></table>
<p>在pthread库支持下，又封装了一次系统调用，通过 <code>pthread_attr_xxxx</code> 来实现设置。</p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>负载均衡是指：尽量让CPU各个核心都均摊处理任务，不能出现1核有难7核围观的情况。</p>
<ul>
<li>每个核的处理调度都是以 <code>task_struct</code> 为基本单位的</li>
<li>核与核之间是通过 push 和 pull 操作来实现任务分配的，在实际运行时一个 <code>task_struct</code> 会在多个核间动态转移<ul>
<li>通过命令 <code>cat /proc/cpuinfo</code> 获取cpu相关具体信息</li>
<li>也可以在 <code>top</code> 命令中按下 <code>1</code> 来获取cpu负载</li>
</ul>
</li>
</ul>
<h2 id="关于运行时间"><a href="#关于运行时间" class="headerlink" title="关于运行时间"></a>关于运行时间</h2><p>一个代码运行时间包括：</p>
<ul>
<li>real time: 用户所感受的运行时间</li>
<li>user time: 代码在user space 运行时间</li>
<li>kernel time: 代码陷入内核的运行时间，也就是计算通过系统调用所花费的时间</li>
</ul>
<p>可以使用命令 <code>time &lt;exec&gt;</code> 来统计一个程序的时间，这个时间的计算依据是根据 <strong>资源为单位</strong> 计算的：</p>
<ul>
<li>当一个程序 fork() 出一个进程，那么一共就有两个进程，对应两个 <code>task_struct</code> 的同时也对应两份资源，所以通过 time 来计算的real time 和 user time 是一致的</li>
<li>当一个程序 create() 出一个线程，那么一共对应两个 <code>task_struct</code> 但只有一份资源，那么在多核上跑时，通过 time 计算的 user time 是 real time 的两倍</li>
<li>在路径 <code>/proc/&lt;pid&gt;/task/</code> 下可以查看具体的 <code>task_struct</code> 信息</li>
</ul>
<p>通过以下实例可以验证:</p>
<ul>
<li>共享一份资源</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">pid_t</span> <span class="title">gettid</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> syscall(__NR_gettid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">thread_func</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;process pid = %d, thread pid = %d, thread_self = %d\n&quot;</span>,</span><br><span class="line">         getpid(), gettid(), pthread_self());</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> tid1, tid2;</span><br><span class="line">  <span class="comment">//pthread_self() 是用户空间库所创建的ID，内核不可见</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;process pid = %d, man thread pid = %d,man thread_self = %d\n&quot;</span>,</span><br><span class="line">         getpid(), gettid(), pthread_self());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;create thread failed:&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;create thread failed:&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;create thread failed:&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>每个 <code>task_struct</code> 对应一份资源</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_handler</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get sig_handler = %d\n&quot;</span>, num);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(waitpid(<span class="number">-1</span>, &amp;status, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;wait signal failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(WIFEXITED(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The child was terminated normally!&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;exit status = %d\n&quot;</span>, WEXITSTATUS(status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(WIFSIGNALED(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The child was terminated by signal %d\n&quot;</span>, WTERMSIG(status));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WCOREDUMP</span></span><br><span class="line">        <span class="keyword">if</span>(WCOREDUMP(status)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;The child produced a core dump!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(WIFSTOPPED(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The chiild process was stopped by delivery of a signal %d\n&quot;</span>,</span><br><span class="line">                WSTOPSIG(status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(WIFCONTINUED(status)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The child process was resumed by delivery of SIGCONT\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(prctl(PR_SET_CHILD_SUBREAPER, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;can not to be a subreaper!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> child_pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(child_pid == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;can not fork process:&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(child_pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;can not fork process:&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf(&quot;childl-&gt; %d parent pid is %d\n&quot;,getpid(), getppid());</span></span><br><span class="line">            <span class="comment">//sleep(1);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//if(signal(SIGCHLD,sig_handler) == SIG_ERR)</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">                <span class="comment">//perror(&quot;wait signal error:&quot;);</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="不同策略下的负载均衡"><a href="#不同策略下的负载均衡" class="headerlink" title="不同策略下的负载均衡"></a>不同策略下的负载均衡</h2><ul>
<li>RT策略下的负载均衡就按照其优先级依次分配到几个核心</li>
<li>NICE策略下的负载均衡是在系统tick时动态分配到核心上</li>
<li>当一个核心空闲时，也会主动pull任务</li>
<li>当有上层调用，最终新建了 <code>task_struct</code> 后，内核也会根据CPU的负载情况主动分配到空闲核心上</li>
</ul>
<h2 id="主动修改负载"><a href="#主动修改负载" class="headerlink" title="主动修改负载"></a>主动修改负载</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_attr_setaffinity_np</span><span class="params">(<span class="keyword">pthread_attr_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">size_t</span> cpusetsize, <span class="keyword">const</span> <span class="keyword">cpu_set_t</span> *cpuset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_attr_getaffinity_np</span><span class="params">(<span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">size_t</span> cpusetsize, <span class="keyword">cpu_set_t</span> *cpuset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sched_setaffinity</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> cpusetsize,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">const</span> <span class="keyword">cpu_set_t</span> *mask)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sched_getaffinity</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">size_t</span> cpusetsize,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">cpu_set_t</span> *mask)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">mask 即为CPU掩码，比如03(16进制)，代表运行于核心0和核心1</span></span><br><span class="line">taskset -a -p &lt;mask&gt; &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<h2 id="中断负载均衡"><a href="#中断负载均衡" class="headerlink" title="中断负载均衡"></a>中断负载均衡</h2><p>除了 <code>task_struct</code> 任务会消耗CPU外，中断和软中断的执行也会消耗CPU，为了能够让多个核能够处理中断所以有时需要做负载均衡(比如将网卡多个fifo均衡到多个核上以提高吞吐量)。</p>
<ul>
<li>其优先级为 中断 &gt; 软中断 &gt; 调度</li>
<li>通过命令 <code>cat /proc/interrupts</code> 可以查看硬中断全局概览</li>
<li>通过命令 <code>cat /proc/softirqs</code> 查看软中断概览</li>
<li>通过命令 <code>cat /proc/irq/&lt;num&gt;/smp_affinity</code> 查看对应 <num> 中断目前的均衡设置，然后以 <code>echo &lt;mask&gt; /proc/irq/&lt;num&gt;/smp_affinity</code> 来设置新的值</li>
</ul>
<h3 id="软中断负载均衡"><a href="#软中断负载均衡" class="headerlink" title="软中断负载均衡"></a>软中断负载均衡</h3><p>当一个核中断发生后，其对应的软中断也必须由此核调用，但如果处理量太大则可以将此核的处理任务再次均分到其他核以快速处理提高吞吐量。</p>
<ul>
<li>在网络上通过 <code>echo &lt;mask&gt; &gt; /sys/class/net/eth1/queues/rx-0/rps_cpus</code> 来打开此功能</li>
</ul>
<h2 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h2><p>将 <code>task_struct</code> 进行分组为多个 group，Linux 再以 group 为单位对其进行均衡。</p>
<h3 id="创建group操作流程"><a href="#创建group操作流程" class="headerlink" title="创建group操作流程"></a>创建group操作流程</h3><ul>
<li>进入路径 <code>/sys/fs/cgroup/</code></li>
<li>新建组名文件 <code>mkdir &lt;group name&gt;</code><ul>
<li>进入文件后发现有 <code>cgroup.procs</code> 用于存储组类成员的pid， <code>cpu.max</code> 存储此组的权重<ul>
<li>修改权重可以修改此组的CPU占用率,越大占用率越高</li>
</ul>
</li>
</ul>
</li>
<li>使用 <code>echo &lt;pid&gt; &gt; cgroup.procs</code> 加入成员到组</li>
</ul>
<h3 id="限制cpu使用率-配额-操作流程"><a href="#限制cpu使用率-配额-操作流程" class="headerlink" title="限制cpu使用率(配额)操作流程"></a>限制cpu使用率(配额)操作流程</h3><ul>
<li>基于上面的基础上，进入此组，先 <code>cat cpu.cfs_periods_us</code> 查看设置的 period 时间</li>
<li>然后 <code>echo &lt;value&gt; cpu.cfs_quota_us</code> 来设置其在period中的占空比<ul>
<li>当 <code>cfs_quota_us</code> 的值大于 <code>cfs_periods_us</code> 时，内核会分配多于的CPU来处理此任务</li>
</ul>
</li>
</ul>
<h1 id="实时性"><a href="#实时性" class="headerlink" title="实时性"></a>实时性</h1><p>硬实时操作系统需要：无论当前系统在做什么事，调度器 <strong>都可以在要求的时间内完成任务切换，这一切都是可以预期的。</strong></p>
<p>而Linux内核在中断，软中断，spinlock等情况下都无法完成调度切换，这个时间是无法预期的，所以其是一个软实时系统。<br>也就是说，系统只保证尽快的完成切换而已。</p>
<h2 id="实时补丁"><a href="#实时补丁" class="headerlink" title="实时补丁"></a>实时补丁</h2><p>在 <a target="_blank" rel="noopener" href="https://wiki.linuxfoundation.org/realtime/start"></a> 给出了实时补丁（需要手动merge到代码中,然后在menuconfig 中配置）。</p>
<p>此补丁做了如下改动：</p>
<ul>
<li>将中断和软中断都修改为线程</li>
<li>将不可调度锁修改为可调度锁</li>
</ul>
<p>这样系统在任何时候都是可以调度的，以此来提高切换速度。</p>
<blockquote>
<p>但由于 Linux 存在内存申请的 Lazy 机制等等，所以仍然无法做到硬实时。</p>
</blockquote>
<p>替代方案： rt thread + linux</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>kcmetercec
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kcmetercec.top/2024/09/02/linux_process_schedule/" title="Linux下进程和线程的调度">http://kcmetercec.top/2024/09/02/linux_process_schedule/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"> <i class="fa fa-tag"></i> linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/08/31/linux_process_hello/" rel="prev" title="Linux下进程和线程的基本概念及操作">
      <i class="fa fa-chevron-left"></i> Linux下进程和线程的基本概念及操作
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/09/02/linux_process_create/" rel="next" title="Linux下进程的创建">
      Linux下进程的创建 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E7%9A%84%E7%9B%AE%E6%A0%87"><span class="nav-number">1.</span> <span class="nav-text">调度的目标</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%9E%E5%90%90%E5%92%8C%E5%93%8D%E5%BA%94"><span class="nav-number">1.1.</span> <span class="nav-text">吞吐和响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU%E4%B8%8EI-O%E5%B9%B3%E8%A1%A1"><span class="nav-number">1.2.</span> <span class="nav-text">CPU与I&#x2F;O平衡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">调度算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">2.1.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%96%E7%95%A5"><span class="nav-number">2.2.</span> <span class="nav-text">策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RT%E7%AD%96%E7%95%A5"><span class="nav-number">2.2.1.</span> <span class="nav-text">RT策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NICE%E7%AD%96%E7%95%A5"><span class="nav-number">2.2.2.</span> <span class="nav-text">NICE策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%96%E7%95%A5%E8%A1%A5%E4%B8%81"><span class="nav-number">2.3.</span> <span class="nav-text">策略补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RT%E9%97%A8%E9%99%90"><span class="nav-number">2.3.1.</span> <span class="nav-text">RT门限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CFS-%E5%AE%8C%E5%85%A8%E5%85%AC%E5%B9%B3%E8%B0%83%E5%BA%A6-NICE%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96"><span class="nav-number">2.3.2.</span> <span class="nav-text">CFS :完全公平调度(NICE策略优化)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEAPI"><span class="nav-number">2.4.</span> <span class="nav-text">设置API</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">3.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4"><span class="nav-number">3.2.</span> <span class="nav-text">关于运行时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%AD%96%E7%95%A5%E4%B8%8B%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.3.</span> <span class="nav-text">不同策略下的负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD"><span class="nav-number">3.4.</span> <span class="nav-text">主动修改负载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">3.4.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell"><span class="nav-number">3.4.2.</span> <span class="nav-text">shell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.5.</span> <span class="nav-text">中断负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%B8%AD%E6%96%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.5.1.</span> <span class="nav-text">软中断负载均衡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cgroup"><span class="nav-number">3.6.</span> <span class="nav-text">cgroup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAgroup%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.6.1.</span> <span class="nav-text">创建group操作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6cpu%E4%BD%BF%E7%94%A8%E7%8E%87-%E9%85%8D%E9%A2%9D-%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.6.2.</span> <span class="nav-text">限制cpu使用率(配额)操作流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E6%97%B6%E6%80%A7"><span class="nav-number">4.</span> <span class="nav-text">实时性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%97%B6%E8%A1%A5%E4%B8%81"><span class="nav-number">4.1.</span> <span class="nav-text">实时补丁</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="kcmetercec"
      src="https://avatars.githubusercontent.com/u/16881795?s=400&u=f62971f44f59d17d823044e709d4668debec7c02&v=4">
  <p class="site-author-name" itemprop="name">kcmetercec</p>
  <div class="site-description" itemprop="description">Qt, C++, linux, CS</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">107</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/KcMeterCEC" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;KcMeterCEC" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kcmeter.cec@gmail.com" title="E-Mail → mailto:kcmeter.cec@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kcmetercec</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">206k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">3:08</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>









<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




    <div id="pjax">
  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'f938893867df78f94802',
      clientSecret: 'b6d8470939c53d26c98c4e3b9d4c9ceb55d6e78e',
      repo        : 'kcmetercec.github.io',
      owner       : 'KcMeterCEC',
      admin       : ['KcMeterCEC'],
      id          : '3c7495273937c2c4ce4e3a3af7455941',
        language: 'zh-CN',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
